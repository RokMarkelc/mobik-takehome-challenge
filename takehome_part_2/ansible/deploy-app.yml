---
# Checking if the Minikube cluster is up and starting it if it's not
- name: Start Minikube
  hosts: debian_bookworm

  tasks:
    - name: Check Minikube cluster's status
      ansible.builtin.command: minikube status | echo $?
      register: minikube_status
      ignore_errors: true

    - name: Start Minikube cluster
      ansible.builtin.command: minikube start --kubernetes-version='v1.34.0' --memory=2560 --cpus=2 --driver=docker
      when: minikube_status.failed
      become: true
      become_user: vagrant

    - name: Check Minikube cluster's status again
      ansible.builtin.command: minikube status
      register: new_minikube_status

    - name: Show cluster status
      debug: var=new_minikube_status.stdout_lines

# Configures the shell to use Minikube's Docker daemon
# https://minikube.sigs.k8s.io/docs/handbook/pushing/#Linux
- name: Configure the shell to use Minikube's Docker daemon
  hosts: debian_bookworm
  become: true
  become_user: vagrant

  tasks:
    - name: Configure shell to use Minikube's Docker daemon
      ansible.builtin.lineinfile:
        path: ~/.profile
        line: "eval $(minikube docker-env)"

# Builds the application images and applies the Kubernetes manifests in the correct order
- name: Build and deploy all the applications
  hosts: debian_bookworm
  become: true
  become_user: vagrant

  tasks:
    # Database
    - name: Deploy Postgres DB with service
      ansible.builtin.command: kubectl apply -f /vagrant/kubernetes/db-deployment.yml

    - name: Wait for Postgres DB to start running
      ansible.builtin.command: kubectl wait -l app=postgres --for=jsonpath='{.status.phase}'=Running --timeout=60s pod
    
    # Backend
    - name: Get backend version
      ansible.builtin.command: cat /vagrant/app/backend/VERSION
      register: backend_version

    - name: Build backend image
      community.docker.docker_image:
        name: app-backend:{{ backend_version.stdout }}
        build:
          path: /vagrant/app/backend
        source: build
      register: output

    - name: Deploy backend with service
      ansible.builtin.shell: sed "s/IMAGE_TAG_PLACEHOLDER/{{ backend_version.stdout }}/g" /vagrant/kubernetes/backend-deployment.yml | kubectl apply -f -

    - name: Wait for backend to start running
      ansible.builtin.command: kubectl wait -l app=backend --for=jsonpath='{.status.phase}'=Running --timeout=10s pod
    
    # Frontend
    - name: Get frontend version
      ansible.builtin.shell: jq .version /vagrant/app/frontend/package.json | tr -d '"'
      register: frontend_version

    - name: Build frontend image
      community.docker.docker_image:
        name: app-frontend:{{ frontend_version.stdout }}
        build:
          path: /vagrant/app/frontend
        source: build
      register: output

    - name: Deploy frontend with service
      ansible.builtin.shell: sed "s/IMAGE_TAG_PLACEHOLDER/{{ frontend_version.stdout }}/g" /vagrant/kubernetes/frontend-deployment.yml | kubectl apply -f -

    - name: Wait for frontend to start running
      ansible.builtin.command: kubectl wait -l app=frontend --for=jsonpath='{.status.phase}'=Running --timeout=10s pod
